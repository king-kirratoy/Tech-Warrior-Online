<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tech Warrior: Final Stable</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; }
        #ui-layer { position: absolute; top: 10px; left: 10px; z-index: 10; pointer-events: none; }
        .stat-readout { background: rgba(0,20,0,0.9); padding: 15px; border: 1px solid #0f0; width: 420px; pointer-events: auto; }
        button { background: #050; color: #0f0; border: 1px solid #0f0; cursor: pointer; margin: 2px; padding: 5px; }
        button:hover { background: #0f0; color: #000; }
        .active { background: #0f0; color: #000; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="stat-readout" id="garage-menu">
        <h2>--- GARAGE ---</h2>
        <div>CHASSIS: 
            <button onclick="setChassis('light')">Light</button>
            <button onclick="setChassis('medium')" class="active">Medium</button>
            <button onclick="setChassis('heavy')">Heavy</button>
        </div>
        <div>LEFT ARM: 
            <button onclick="setWeapon('L', 'mg')">MG</button>
            <button onclick="setWeapon('L', 'heavy')">Heavy</button>
            <button onclick="setWeapon('L', 'shield')">Shield</button>
        </div>
        <div>RIGHT ARM: 
            <button onclick="setWeapon('R', 'mg')">MG</button>
            <button onclick="setWeapon('R', 'heavy')">Heavy Gun</button>
            <button onclick="setWeapon('R', 'sword')">Sword</button>
        </div>
        <hr style="border:0; border-top:1px solid #0f0; margin:10px 0;">
        <div id="weight-display">TONNAGE: 25 / 125</div>
        <button id="deploy-btn" style="width:100%; font-weight:bold;" onclick="deployMech()">DEPLOY UNIT</button>
    </div>
</div>

<script>
// --- GLOBAL DATA ---
let loadout = { chassis: 'medium', L: 'mg', R: 'mg', color: 0x00ff00 };
let isDeployed = false;
let player, torso, legs, keys, bullets;

const CHASSIS = {
    light:  { maxW: 75,  speed: 400, scale: 0.7 },
    medium: { maxW: 125, speed: 250, scale: 1.0 },
    heavy:  { maxW: 200, speed: 150, scale: 1.4 }
};

// --- PHASER SETUP ---
const config = {
    type: Phaser.AUTO,
    width: window.innerWidth,
    height: window.innerHeight,
    physics: { default: 'arcade', arcade: { debug: false } },
    scene: { create: create, update: update }
};

const game = new Phaser.Game(config);

function create() {
    // Add a simple background grid so we know it's working
    this.add.grid(window.innerWidth/2, window.innerHeight/2, 2000, 2000, 64, 64, 0x000000, 0, 0x004400, 0.5);
    
    keys = this.input.keyboard.addKeys('W,A,S,D');
    bullets = this.physics.add.group();
    
    // Spawn simple targets
    this.targets = this.physics.add.group();
    for(let i=0; i<5; i++) {
        let t = this.add.rectangle(Phaser.Math.Between(100, 700), Phaser.Math.Between(100, 500), 40, 40, 0xff0000);
        this.targets.add(t);
        this.physics.add.existing(t);
        t.body.setVelocity(50, 50).setBounce(1,1).setCollideWorldBounds(true);
    }

    this.input.on('pointerdown', () => {
        if (!isDeployed) return;
        let b = this.add.circle(player.x, player.y, 6, 0xffff00);
        this.physics.add.existing(b);
        this.physics.velocityFromRotation(torso.rotation, 600, b.body.velocity);
    });
}

function deployMech() {
    document.getElementById('garage-menu').style.display = 'none';
    
    let scene = game.scene.scenes[0];
    let stats = CHASSIS[loadout.chassis];

    // Create a physical base (Legs)
    player = scene.add.rectangle(window.innerWidth/2, window.innerHeight/2, 50, 50, 0x222222).setStrokeStyle(2, 0xffffff);
    scene.physics.add.existing(player);
    player.setScale(stats.scale);
    player.body.setCollideWorldBounds(true);

    // Create the visual Top (Torso)
    torso = scene.add.rectangle(0, 0, 50, 50, loadout.color).setStrokeStyle(2, 0xffffff);
    torso.setScale(stats.scale);
    
    // Arm visuals
    let lArm = scene.add.rectangle(-30, 0, 15, 30, 0xaaaaaa);
    let rArm = scene.add.rectangle(30, 0, 15, 30, 0xaaaaaa);
    
    // We don't use a container here because it's prone to breaking. 
    // We just update their positions in the update loop.
    player.torsoSprite = torso;
    player.lArm = lArm;
    player.rArm = rArm;

    isDeployed = true;
}

function update() {
    if (!isDeployed) return;

    // Move the legs with WASD
    let speed = CHASSIS[loadout.chassis].speed;
    player.body.setVelocity(0);
    
    if (keys.W.isDown) this.physics.velocityFromRotation(player.rotation, speed, player.body.velocity);
    if (keys.S.isDown) this.physics.velocityFromRotation(player.rotation, -speed/2, player.body.velocity);
    if (keys.A.isDown) player.body.setAngularVelocity(-200);
    else if (keys.D.isDown) player.body.setAngularVelocity(200);
    else player.body.setAngularVelocity(0);

    // Make Torso/Arms follow the legs
    torso.setPosition(player.x, player.y);
    player.lArm.setPosition(player.x, player.y);
    player.rArm.setPosition(player.x, player.y);

    // Torso points to Mouse
    let mouseAngle = Phaser.Math.Angle.Between(player.x, player.y, this.input.x, this.input.y);
    torso.setRotation(mouseAngle);
    player.lArm.setRotation(mouseAngle);
    player.rArm.setRotation(mouseAngle);
    
    // Offset the arms based on rotation so they stay on the sides
    player.lArm.x += Math.cos(mouseAngle - Math.PI/2) * (30 * player.scale);
    player.lArm.y += Math.sin(mouseAngle - Math.PI/2) * (30 * player.scale);
    player.rArm.x += Math.cos(mouseAngle + Math.PI/2) * (30 * player.scale);
    player.rArm.y += Math.sin(mouseAngle + Math.PI/2) * (30 * player.scale);
}

// --- UI HELPERS ---
function setChassis(type) { loadout.chassis = type; updateButtonStyles(); }
function setWeapon(side, type) { if(side === 'L') loadout.L = type; else loadout.R = type; }
function updateButtonStyles() {
    // Basic logic to show the weight change
    document.getElementById('weight-display').innerText = `TONNAGE: ${CHASSIS[loadout.chassis].maxW} / ${CHASSIS[loadout.chassis].maxW}`;
}
</script>
</body>
</html>
