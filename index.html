<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tech Warrior: Alpha 3.0</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        /* Modern high-tech base colors */
        body { 
            margin: 0; 
            background: #0c1014; /* Deep cold gray from image */
            color: #c8d2d9; /* Off-white technical text */
            font-family: 'Verdana', 'Segoe UI', sans-serif; /* Cleaner modern font */
            overflow: hidden; 
        }

        #ui-layer {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 1000;
        }
        
        /* Modernized Garage Menu */
        .stat-readout { 
            background: rgba(12, 16, 20, 0.95); /* Semi-transparent blue-gray */
            padding: 25px; 
            border: 1px solid rgba(0, 255, 0, 0.5); /* Subtle neon border */
            width: 750px; 
            pointer-events: auto; 
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.15); /* Soft holographic glow */
            margin: 0; 
            border-radius: 10px;
        }

/* --- MODERNIZED AC6 DATA CELLS --- */
.row { 
    margin-bottom: 22px; 
    display: flex; 
    flex-direction: column; /* Moves labels (CHASSIS, etc.) ABOVE the buttons */
    gap: 6px; 
}

/* Label styling for the section headers */
.row-label {
    font-size: 11px;
    color: rgba(0, 255, 0, 0.7); /* Neon green at lower opacity */
    letter-spacing: 1.5px;
    text-transform: uppercase;
    font-weight: bold;
}

/* Container to hold the horizontal buttons */
.options-group {
    display: flex;
    gap: 5px;
}

/* Modernized Technical Buttons */
button { 
    background: rgba(255, 255, 255, 0.04); /* Transparent dark glass look */
    color: #c8d2d9; 
    border: 1px solid rgba(255, 255, 255, 0.1); 
    border-left: 3px solid transparent; /* Hidden until active */
    cursor: pointer; 
    padding: 10px 12px; 
    font-size: 13px;
    text-align: left; /* Aligns text to the left like the AC6 list */
    flex: 1; /* Ensures buttons fill the row width evenly */
    transition: all 0.2s ease;
    font-family: 'Segoe UI', sans-serif;
}

button:hover { 
    background: rgba(0, 255, 0, 0.08); 
    border-color: rgba(0, 255, 0, 0.3); 
}

#deploy-btn {
    width: 100%;
    font-size: 18px;
    margin-top: 15px;
    padding: 15px;
    
    /* Overriding the global 'text-align: left' */
    text-align: center; 
    display: flex;
    justify-content: center;
    align-items: center;

    /* Matching the AC6 theme but without the left-side bar */
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid rgba(0, 255, 0, 0.5);
    border-left: 1px solid rgba(0, 255, 0, 0.5); /* Removes the 3px 'pip' */
    color: #fff;
    text-transform: uppercase;
    letter-spacing: 2px;
    transition: 0.3s;
}

#deploy-btn:hover {
    background: rgba(0, 255, 0, 0.2);
    box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
}

#deploy-btn:disabled {
    background: rgba(255, 0, 0, 0.05);
    border-color: rgba(255, 0, 0, 0.2);
    color: rgba(255, 255, 255, 0.2);
    cursor: not-allowed;
}

/* The "Selected" state with the glowing left-side accent */
button.active { 
    background: rgba(0, 255, 0, 0.12); 
    color: #fff; 
    border-color: rgba(0, 255, 0, 0.5);
    border-left: 3px solid #0f0; /* The tactical highlight bar */
    box-shadow: inset 8px 0 15px rgba(0, 255, 0, 0.05);
}
        /* Unified HUD Console (Modernized) */
        #hud-container { position: absolute; bottom: 30px; left: 30px; z-index: 100; visibility: hidden; }
        
        .console-frame { 
            display: flex; 
            align-items: flex-end; 
            gap: 20px; 
            padding: 15px; 
            background: rgba(12, 16, 20, 0.85); 
            border-left: 4px solid #0f0; /* Accent strip on the side */
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.5);
        }

        .stats-group { display: flex; flex-direction: column; gap: 6px; }
        .hud-label { font-weight: bold; font-size: 11px; color: #0f0; opacity: 0.8; text-transform: uppercase; }
        
        #hp-bar { width: 250px; height: 18px; background: rgba(0, 40, 0, 0.3); border: 1px solid rgba(0, 255, 0, 0.3); }
        #hp-fill { height: 100%; background: #0f0; transition: width 0.2s; box-shadow: 0 0 10px rgba(0, 255, 0, 0.5); }
        
        #sh-bar { width: 250px; height: 6px; background: rgba(0, 20, 40, 0.3); border: 1px solid rgba(0, 255, 255, 0.3); margin-top: 2px; }
        #sh-fill { height: 100%; background: #00ffff; box-shadow: 0 0 8px #00ffff; transition: width 0.3s; }

        #weapon-slots { display: flex; gap: 10px; }
        .weapon-box { 
            width: 60px; height: 60px; 
            border: 1px solid rgba(0, 255, 0, 0.4); 
            background: rgba(255, 255, 255, 0.03); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: #c8d2d9; 
        }
        .weapon-box.active-firing { border-color: #fff; box-shadow: 0 0 15px #fff; color: #fff; background: rgba(255, 255, 255, 0.1); }
        
        .arm-label { opacity: 0.5; font-size: 9px; text-transform: uppercase; }
        .weap-name { font-weight: bold; font-size: 11px; }

        .color-btn { 
    		width: 22px;   
    		height: 22px;  
    		border: 1px solid #444; 
    		display: inline-block; 
    		cursor: pointer; 
    		margin-right: 6px; 
    		transition: 0.2s; 
    		pointer-events: auto; 
    		vertical-align: middle; 
	}
        
	.color-btn.active { 
    		border: 2px solid #fff; 
    		transform: scale(1.2); /* Makes the selected one pop slightly */
    		box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); 
	}
        
        .pulse-warning { animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { opacity: 1; filter: brightness(1.5); } to { opacity: 0.4; } }

/* --- WEIGHT CAPACITY BAR --- */
#weight-bar-bg {
    width: 100%;
    height: 8px;
    background: rgba(255, 255, 255, 0.05); /* Matching the button transparency */
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin-bottom: 10px;
    overflow: hidden;
    /* Optional: Subtle glow to the container */
    box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
}

#weight-bar-fill {
    height: 100%;
    background: #0f0;
    transition: width 0.3s ease, background-color 0.3s;
    /* Makes the bar itself glow slightly */
    box-shadow: 0 0 10px rgba(0, 255, 0, 0.4);
}

        /* Custom scrollbar for a tech look if needed */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0c1014; }
        ::-webkit-scrollbar-thumb { background: #0f0; }
    </style>
</head>
<body>

<div id="ui-layer">
    
    <div class="stat-readout" id="garage-menu" style="width: 750px;">
        
        <h2 style="text-align:center; margin-top:0; margin-bottom: 25px; letter-spacing: 2px; color: #0f0;">--- MECH HANGAR ---</h2>
        
        <div style="display: flex; gap: 20px; align-items: flex-start;">
            
<div style="flex: 1.4;">
    
    <div class="row">
        <span class="row-label">■ Chassis</span>
        <div class="options-group">
            <button id="c-light" onclick="setChassis('light')">Light</button>
            <button id="c-medium" onclick="setChassis('medium')" class="active">Medium</button>
            <button id="c-heavy" onclick="setChassis('heavy')">Heavy</button>
        </div>
    </div>

    <div class="row">
        <span class="row-label">■ Left Arm</span>
        <div class="options-group">
            <button id="l-mg" onclick="setWeapon('L','mg')" class="active">MG</button>
            <button id="l-heavy" onclick="setWeapon('L','heavy')">HVY</button>
            <button id="l-sword" onclick="setWeapon('L','sword')">SWRD</button>
        </div>
    </div>

    <div class="row">
        <span class="row-label">■ Right Arm</span>
        <div class="options-group">
            <button id="r-shield" onclick="setWeapon('R','shield')">SHLD</button>
            <button id="r-gl" onclick="setWeapon('R','gl')" class="active">GL</button>
        </div>
    </div>

    <div class="row">
        <span class="row-label">■ System Mods</span>
        <div class="options-group">
            <button id="m-none" onclick="setMod('none')" class="active">NONE</button>
            <button id="m-jump" onclick="setMod('jump')">JUMP JETS</button>
        </div>
    </div>

    <div class="row">
        <span class="row-label">■ Armour Color</span>
        <div class="options-group" style="justify-content: flex-start;">
            <div id="col-00ff00" class="color-btn active" style="background:#00ff00" onclick="setColor(0x00ff00)"></div>
            <div id="col-0088ff" class="color-btn" style="background:#0088ff" onclick="setColor(0x0088ff)"></div>
            <div id="col-ff3300" class="color-btn" style="background:#ff3300" onclick="setColor(0xff3300)"></div>
            <div id="col-ffff00" class="color-btn" style="background:#ffff00" onclick="setColor(0xffff00)"></div>
        </div>
    </div>
</div>

            <div id="preview-container" style="width: 280px; height: 180px; border: 1px solid #0f0; background: rgba(0,20,0,0.5); display: flex; justify-content: center; align-items: center;">
                <img id="preview-img" src="assets/medium-mech.png" style="max-width: 100%; max-height: 100%; object-fit: contain; filter: drop-shadow(0 0 5px #0f0);">
            </div>
        </div>
        
        <div id="weight-display" style="text-align:center; font-weight:bold; font-size: 14px; margin-bottom: 4px; margin-top: 20px;">
    WEIGHT: 75 / 100
	</div>

        <div id="weight-bar-bg" style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border: 1px solid #444; margin-bottom: 10px; overflow: hidden;">
            <div id="weight-bar-fill" style="width: 0%; height: 100%; background: #0f0; transition: width 0.3s ease;"></div>
        </div>

        <button id="deploy-btn" onclick="deployMech()">DEPLOY MECH</button>
        
    </div>
</div>

    <div id="hud-container">
        <div class="console-frame">
            <div class="stats-group">
                <div class="hud-label">HEALTH</div>
                <div id="hp-bar"><div id="hp-fill" style="width: 100%;"></div></div>
                <div class="hud-label" style="color: #00ffff;">SHIELD</div>
                <div id="sh-bar"><div id="sh-fill" style="width: 100%;"></div></div>
            </div>
            <div id="weapon-slots">
                <div id="slot-L" class="weapon-box"><span class="arm-label">L-ARM</span><span id="txt-L" class="weap-name">MG</span></div>
                <div id="slot-R" class="weapon-box"><span class="arm-label">R-ARM</span><span id="txt-R" class="weap-name">GL</span></div>
            </div>
        </div>
    </div>
</div>

<script>
const WEAPONS = {
    none:  { name: 'NONE', color: 0x333333, reload: 0, dmg: 0, w: 0 },
    mg:    { name: 'MG', color: 0xaaaaaa, reload: 200, dmg: 10, w: 50 },
    heavy: { name: 'HEAVY', color: 0x555555, reload: 1500, dmg: 40, w: 75 },
    sword: { name: 'SWORD', color: 0xffffff, reload: 600, dmg: 60, isMelee: true, w: 50 },
    shield:{ name: 'SHIELD', color: 0x00ffff, isShield: true, w: 25 },
    gl:    { name: 'G.LAUNCHER', color: 0xffaa00, reload: 3500, dmg: 100, isGL: true, w: 100 }
};

const CHASSIS = {
    light:  { max: 100, spd: 400, scale: 0.7, hp: 300 },
    medium: { max: 150, spd: 280, scale: 1.0, hp: 450 },
    heavy:  { max: 200, spd: 180, scale: 1.4, hp: 600 }
};

// --- INITIAL LOADOUT CONFIGURATION ---
let loadout = {
    chassis: 'light',  
    L: 'mg',
    R: 'shield',     
    mod: 'none',
    color: 0x00ff00 
};

let player, torso, legMarker, swordSlash, keys, bullets, enemies, shieldGraphic;
let reloadBar, reloadBg, jumpBar, jumpBg, isDeployed = false, activeArm = 'L', reloadL = 0, reloadR = 0, lastJumpTime = 0, lastDamageTime = 0, isJumping = false, smokeParticles;

const config = {
    type: Phaser.AUTO,
    width: window.innerWidth, height: window.innerHeight,
    physics: { default: 'arcade' },
    scene: { preload: preload, create: create, update: update }
};
const game = new Phaser.Game(config);

function preload() {
    let g = this.make.graphics({x: 0, y: 0, add: false});
    g.fillStyle(0xffffff, 1); g.fillCircle(10, 10, 10);
    g.generateTexture('smoke', 20, 20);
}

function create() {
    // 1. World Setup
    this.add.grid(window.innerWidth/2, window.innerHeight/2, 4000, 4000, 64, 64, 0, 0, 0x004400, 0.3);
    keys = this.input.keyboard.addKeys('W,A,S,D,SPACE');
    
    // 2. Physics Groups
    bullets = this.physics.add.group();
    enemies = this.physics.add.group();

    // 3. Collision Rules
    this.physics.add.overlap(bullets, enemies, (bullet, enemy) => {
        if (!bullet.isGLBall) {
            bullet.destroy(); 
            damageEnemy(enemy, 15); 
        }
    });

    // 4. Input Listeners
    this.input.on('pointerdown', () => fire(this));
    this.input.on('wheel', () => { activeArm = (activeArm === 'L' ? 'R' : 'L'); updateHUD(); });
    for(let i=0; i<6; i++) spawnEnemy(this);

    // 5. MODERN HANGAR OVERLAY (Add this here)
    // Dark blue-gray tint overlay
    this.hangarOverlay = this.add.rectangle(window.innerWidth/2, window.innerHeight/2, window.innerWidth, window.innerHeight, 0x0c1014, 0.7);
    this.hangarOverlay.setScrollFactor(0).setDepth(1000); // Fixed to screen, high depth

    // Subtle technical grid/scanlines
    this.hangarGrid = this.add.grid(window.innerWidth/2, window.innerHeight/2, window.innerWidth, window.innerHeight, 16, 16, 0, 0, 0x00ff00, 0.05);
    this.hangarGrid.setScrollFactor(0).setDepth(1001); // Sits right on top of the overlay
}

function spawnEnemy(scene) {
    let x = Phaser.Math.Between(200, window.innerWidth - 200);
    let y = Phaser.Math.Between(200, window.innerHeight - 200);
    let e = scene.add.rectangle(x, y, 40, 40, 0xff0000).setStrokeStyle(2, 0xffffff);
    scene.physics.add.existing(e);
    e.health = 50;
    e.bar = scene.add.rectangle(x, y-35, 40, 5, 0x00ff00);
    enemies.add(e);
}

function damageEnemy(e, amt) {
    e.health -= amt;
    if(e.bar) e.bar.width = Math.max(0, (e.health / 50) * 40);
    if (e.health <= 0) { if(e.bar) e.bar.destroy(); e.destroy(); setTimeout(() => spawnEnemy(game.scene.scenes[0]), 2000); }
}

function deployMech() {
    // 1. UI Toggle
    document.getElementById('garage-menu').style.display = 'none';
    document.getElementById('hud-container').style.visibility = 'visible';
    
    // 2. Scene Context
    let scene = game.scene.scenes[0];
    let s = CHASSIS[loadout.chassis];

    // 3. CLEAN UP HANGAR VISUALS
    // Hide the modern hangar overlay and grid we added in create()
    if (scene.hangarOverlay) scene.hangarOverlay.setVisible(false);
    if (scene.hangarGrid) scene.hangarGrid.setVisible(false);

    // 4. Create Player & Physics
    player = scene.add.rectangle(window.innerWidth/2, window.innerHeight/2, 70, 50, 0x222222).setStrokeStyle(2, 0xffffff).setDepth(5);
    scene.physics.add.existing(player);
    player.setScale(s.scale).body.setCollideWorldBounds(true);
    
    // 5. Initialize Stats
    player.maxHp = s.hp; 
    player.hp = s.hp;
    player.shield = 100;

    // 6. Assemble Mech Model
    legMarker = scene.add.rectangle(0, 0, 6, 50, 0xff6600).setDepth(6).setScale(s.scale);
    
    // Use the Shape-Only system for perfect top-down rotation
    torso = buildShapeMech(scene, loadout.chassis, loadout.color);
    torso.setDepth(10);
    
    // 7. FX & Combat Systems
    swordSlash = scene.add.arc(0, 0, 60, 0, 90, false, 0xffffff, 0.8).setVisible(false).setDepth(15);
    reloadBg = scene.add.rectangle(0, 0, 50, 6, 0x333333).setDepth(20).setVisible(false);
    reloadBar = scene.add.rectangle(0, 0, 50, 6, 0xffff00).setDepth(21).setVisible(false);
    
    // Jump Jet Bars (HUD logic now uses these in update)
    jumpBg = scene.add.rectangle(0, 0, 50, 4, 0x331100).setDepth(15).setVisible(false);
    jumpBar = scene.add.rectangle(0, 0, 50, 4, 0xff6600).setDepth(16).setVisible(false);
    
    shieldGraphic = scene.add.arc(0,0, 70, 330, 30, false, 0x00ffff, 0.3).setStrokeStyle(3, 0x00ffff).setVisible(false).setDepth(12);
    
    // Particle Depth - keep below mech
    smokeParticles = scene.add.particles(0, 0, 'smoke', { 
        scale: { start: 0.5, end: 0 }, 
        alpha: { start: 0.4, end: 0 }, 
        lifespan: 500, 
        speed: 30, 
        follow: player, 
        on: false 
    }).setDepth(4);

    isDeployed = true;
    updateHUD();
}

function buildShapeMech(scene, type, color) {
    let container = scene.add.container(0, 0);
    let s = CHASSIS[type].scale;

    if (type === 'heavy') {
        // HEAVY: A wide, tank-like brutalist design
        let shoulders = scene.add.rectangle(0, 0, 100, 40, 0x333333).setStrokeStyle(2, 0xffffff);
        let core = scene.add.rectangle(0, 0, 60, 70, color).setStrokeStyle(2, 0xffffff);
        let cockpit = scene.add.rectangle(20, 0, 15, 30, 0x00ffff).setStrokeStyle(1, 0xffffff);
        let vents = scene.add.rectangle(-20, 0, 10, 40, 0x222222); 
        container.add([shoulders, core, vents, cockpit]);
    } 
    else if (type === 'light') {
        // LIGHT: Sleek, aerodynamic, "V" shaped
        let shoulders = scene.add.rectangle(0, 0, 15, 60, 0x444444).setStrokeStyle(2, 0xffffff);
        let core = scene.add.rectangle(10, 0, 20, 10, color).setStrokeStyle(2, 0xffffff);
        let cockpit = scene.add.rectangle(22, 0, 15, 20, 0x0F61A1).setStrokeStyle(1, 0xffffff);
        let engine = scene.add.rectangle(-15, 0, 15, 25, 0x222222);
        container.add([shoulders, core, cockpit]);
    } 
    else {
        // MEDIUM: The Classic balanced silhouette
        let shoulders = scene.add.rectangle(0, 0, 35, 80, 0x444444).setStrokeStyle(2, 0xffffff);
        let core = scene.add.rectangle(10, 0, 40, 30, color).setStrokeStyle(2, 0xffffff);
        let cockpit = scene.add.rectangle(22, 0, 15, 20, 0x0F61A1).setStrokeStyle(1, 0xffffff);
        let engine = scene.add.rectangle(-15, 0, 15, 25, 0x222222);
        container.add([shoulders, core, cockpit]);
    }

    container.setScale(s);
    return container;
}

function fire(scene) {
    if (!isDeployed || isJumping) return;
    let now = scene.time.now;
    let wKey = activeArm === 'L' ? loadout.L : loadout.R;
    let weapon = WEAPONS[wKey];
    let last = activeArm === 'L' ? reloadL : reloadR;

    if (now < last || weapon.isShield || wKey === 'none') return;

    // Visual feedback for the UI slot
    let slotId = 'slot-' + activeArm;
    document.getElementById(slotId).classList.add('active-firing');
    scene.time.delayedCall(100, () => document.getElementById(slotId).classList.remove('active-firing'));

    if (weapon.isGL) {
        let targetX = scene.input.activePointer.worldX;
        let targetY = scene.input.activePointer.worldY;
        let distance = Phaser.Math.Distance.Between(torso.x, torso.y, targetX, targetY);
        
        let ball = scene.add.circle(torso.x, torso.y, 10, 0xffaa00).setStrokeStyle(2, 0xffffff).setDepth(14);
        scene.physics.add.existing(ball);
        ball.isGLBall = true;
        scene.physics.velocityFromRotation(torso.rotation, distance * 2, ball.body.velocity);
        ball.body.setDrag(distance * 2); 

        // FIX: Improved Timer Text Logic
        let timerText = scene.add.text(ball.x, ball.y - 25, '3', { fontSize: '18px', color: '#fff', fontStyle: 'bold' }).setOrigin(0.5).setDepth(20);
        let count = 3;

        // Update text position every frame
        const updateTimerPos = () => {
            if (ball.active && timerText.active) {
                timerText.setPosition(ball.x, ball.y - 25);
            } else {
                scene.events.off('update', updateTimerPos);
            }
        };
        scene.events.on('update', updateTimerPos);

        scene.time.addEvent({
            delay: 1000, repeat: 2,
            callback: () => {
                count--;
                if (count > 0) { 
                    if (timerText.active) timerText.setText(count); 
                } else if (ball.active) {
                    let blast = scene.add.circle(ball.x, ball.y, 100, 0xff6600, 0.6).setDepth(15);
                    scene.physics.add.existing(blast);
                    scene.physics.add.overlap(blast, enemies, (z, e) => damageEnemy(e, 100));
                    
                    if (Phaser.Math.Distance.Between(blast.x, blast.y, player.x, player.y) < 100) {
                        takePlayerDamage(75);
                    }
                    
                    scene.tweens.add({ targets: blast, scale: 1.5, alpha: 0, duration: 300, onComplete: () => blast.destroy() });
                    timerText.destroy(); 
                    ball.destroy();
                }
            }
        });
    } else if (weapon.isMelee) {
        swordSlash.setPosition(player.x, player.y).setRotation(torso.rotation - 0.7).setVisible(true);
        scene.time.delayedCall(150, () => swordSlash.setVisible(false));
        let hit = scene.add.circle(torso.x + Math.cos(torso.rotation)*50, torso.y + Math.sin(torso.rotation)*50, 50);
        scene.physics.add.existing(hit);
        scene.physics.add.overlap(hit, enemies, (z, e) => damageEnemy(e, weapon.dmg));
        scene.time.delayedCall(100, () => hit.destroy());
} else {
        // --- STEP 1: CREATE THE BULLET ---
        let bulletSize = (wKey === 'heavy') ? 12 : 6;
        let b = scene.add.circle(torso.x, torso.y, bulletSize, 0xffff00);
        
        scene.physics.add.existing(b); 
        bullets.add(b); 
        scene.physics.velocityFromRotation(torso.rotation, 1000, b.body.velocity);
        
        // --- STEP 2: APPLY KICKBACK (ONLY FOR HEAVY GUN) ---
        if (wKey === 'heavy') {
            const kickbackForce = 150; 
            // We subtract the force from the player's current velocity
            // to push them in the opposite direction of the shot.
            player.body.velocity.x -= Math.cos(torso.rotation) * kickbackForce;
            player.body.velocity.y -= Math.sin(torso.rotation) * kickbackForce;
            
            // Add a small camera shake for impact
            scene.cameras.main.shake(100, 0.005);
        }

        // --- STEP 3: CLEANUP ---
        scene.time.delayedCall(2000, () => { if(b.active) b.destroy(); });
    }

    if (activeArm === 'L') { reloadL = now + weapon.reload; player.lastL = now; }
    else { reloadR = now + weapon.reload; player.lastR = now; }
}

function takePlayerDamage(amt) {
    lastDamageTime = game.scene.scenes[0].time.now;
    let wKey = activeArm === 'L' ? loadout.L : loadout.R;
    let isShieldActive = WEAPONS[wKey].isShield && !isJumping;

    if (isShieldActive && player.shield > 0) {
        player.shield -= amt * 0.5;
        amt *= 0.5;
        if (player.shield < 0) player.shield = 0;
    }

    player.hp -= amt;
    updateBars();

    torso.setFillStyle(0xffffff);
    game.scene.scenes[0].time.delayedCall(50, () => torso.setFillStyle(loadout.color));
    if (player.hp <= 0) location.reload();
}

function updateBars() {
    let hpPercent = (player.hp / player.maxHp) * 100;
    document.getElementById('hp-fill').style.width = Math.max(0, hpPercent) + "%";
    document.getElementById('sh-fill').style.width = Math.max(0, player.shield) + "%";
    document.getElementById('hp-fill').style.background = hpPercent < 25 ? "red" : "#0f0";
}

function update(time) {
    if (!isDeployed) return;

    // 1. Shield Regen Logic
    if (time > lastDamageTime + 3000 && player.shield < 100) {
        player.shield += 0.2;
        updateBars();
    }

    // 2. Jump Jet Activation & HUD
    let s = CHASSIS[loadout.chassis].spd;
    let jumpCooldown = 2000;

    if (keys.SPACE.isDown && loadout.mod === 'jump' && !isJumping && time > lastJumpTime + jumpCooldown) {
        isJumping = true; 
        lastJumpTime = time;
        this.physics.velocityFromRotation(player.rotation, 600, player.body.velocity);
        
        // Tween the entire torso container for the "jump" look
        this.tweens.add({ 
            targets: [player, torso], 
            scale: '+=0.2', 
            duration: 200, 
            yoyo: true, 
            onComplete: () => isJumping = false 
        });
    }

    // Update Jump HUD Position & Progress
    if (loadout.mod === 'jump') {
        let elapsed = time - lastJumpTime;
        if (elapsed < jumpCooldown) {
            jumpBg.setVisible(true).setPosition(player.x, player.y + 45);
            jumpBar.setVisible(true).setPosition(player.x, player.y + 45);
            let progress = Math.min(1, elapsed / jumpCooldown);
            jumpBar.width = progress * 50;
            jumpBar.setFillStyle(progress === 1 ? 0x00ff00 : 0xff6600);
        } else {
            jumpBg.setVisible(false);
            jumpBar.setVisible(false);
        }
    }

    // 3. Movement Logic
    if (!isJumping) {
        player.body.setVelocity(0);
        if (keys.W.isDown) this.physics.velocityFromRotation(player.rotation, s, player.body.velocity);
        if (keys.S.isDown) this.physics.velocityFromRotation(player.rotation, -s/2, player.body.velocity);
        if (keys.A.isDown) player.body.setAngularVelocity(-200);
        else if (keys.D.isDown) player.body.setAngularVelocity(200);
        else player.body.setAngularVelocity(0);
    }

    // 4. Torso & Leg Sync
    torso.setPosition(player.x, player.y);
    let angle = Phaser.Math.Angle.Between(player.x, player.y, this.input.activePointer.worldX, this.input.activePointer.worldY);
    torso.setRotation(angle);

    // Leg marker shows movement direction vs torso aiming direction
    legMarker.setPosition(
        player.x + Math.cos(player.rotation) * (35 * player.scale), 
        player.y + Math.sin(player.rotation) * (35 * player.scale)
    ).setRotation(player.rotation);

    // 5. Weapon FX
    let weapon = WEAPONS[activeArm === 'L' ? loadout.L : loadout.R];
    shieldGraphic.setPosition(player.x, player.y).setRotation(angle).setVisible(weapon.isShield && !isJumping);

    // 6. Enemy UI Sync
    enemies.children.each(e => { 
        if(e.bar) e.bar.setPosition(e.x, e.y - 35); 
    });
}

function updateHUD() {
    document.getElementById('txt-L').innerText = loadout.L.toUpperCase();
    document.getElementById('txt-R').innerText = loadout.R.toUpperCase();
    document.getElementById('slot-L').style.borderColor = activeArm === 'L' ? '#fff' : '#0f0';
    document.getElementById('slot-R').style.borderColor = activeArm === 'R' ? '#fff' : '#0f0';
    document.getElementById('slot-L').style.opacity = activeArm === 'L' ? '1' : '0.5';
    document.getElementById('slot-R').style.opacity = activeArm === 'R' ? '1' : '0.5';
}

function setChassis(t) { loadout.chassis = t; refreshGarage(); }
function setWeapon(s, t) { if(s === 'L') loadout.L = t; else loadout.R = t; refreshGarage(); }
function setMod(t) { loadout.mod = t; refreshGarage(); }
function setColor(c) { loadout.color = c; refreshGarage(); }

function refreshGarage() {
    // --- UI STATE CLEANUP ---
    // Clears all active highlights from buttons and color swatches
    document.querySelectorAll('button, .color-btn').forEach(b => b.classList.remove('active'));

    // --- SELECTION HIGHLIGHTING ---
    // Maps current loadout selections to their corresponding HTML Button IDs
    const buttons = [
        'c-' + loadout.chassis,
        'l-' + loadout.L,
        'r-' + loadout.R,
        'm-' + loadout.mod
    ];
    buttons.forEach(id => {
        let el = document.getElementById(id);
        if (el) el.classList.add('active');
    });

    // --- MECH PREVIEW UPDATE ---
    // Swaps the image source and applies the color-coded holographic glow
    const previewImg = document.getElementById('preview-img');
    if (previewImg) {
        // Matches the lowercase filename convention (e.g., assets/light-mech.png)
        previewImg.src = `assets/${loadout.chassis}-mech.png`;
        
        let hexColor = "#" + loadout.color.toString(16).padStart(6, '0');
        previewImg.style.filter = `drop-shadow(0 0 15px ${hexColor})`;
    }

    // --- COLOR SWATCH HIGHLIGHTING ---
    // Highlights the small square color picker based on the current hex code
    let cid = "col-" + loadout.color.toString(16).padStart(6, '0').toLowerCase();
    let colEl = document.getElementById(cid);
    if (colEl) colEl.classList.add('active');

    // --- WEIGHT CALCULATIONS ---
    // Sums the weight of weapons and system mods against the chassis capacity
    let lWeight = WEAPONS[loadout.L].w;
    let rWeight = WEAPONS[loadout.R].w;
    let modWeight = (loadout.mod === 'jump' ? 25 : 0); // Jump jets add 25 tons
    let total = lWeight + rWeight + modWeight;
    let max = CHASSIS[loadout.chassis].max; // Maximum tonnage based on chassis choice
    
    // --- CAPACITY BAR & TEXT DISPLAY ---
    // Updates the numeric readout and visualizes load via the progress bar
    const weightDisplay = document.getElementById('weight-display');
    const barFill = document.getElementById('weight-bar-fill');
    
    weightDisplay.innerText = `WEIGHT: ${total} / ${max}`;
    
    // Calculate percentage and update bar width
    let percentage = Math.min(100, (total / max) * 100);
    if (barFill) barFill.style.width = percentage + "%";
    
    // --- OVERWEIGHT VALIDATION ---
    // Colors the UI red and prevents deployment if the weight limit is exceeded
    if (total > max) {
        weightDisplay.style.color = '#f00';
        if (barFill) barFill.style.background = '#f00';
        document.getElementById('deploy-btn').disabled = true;
        document.getElementById('deploy-btn').style.opacity = "0.5";
    } else {
        weightDisplay.style.color = '#0f0';
        if (barFill) barFill.style.background = '#0f0';
        document.getElementById('deploy-btn').disabled = false;
        document.getElementById('deploy-btn').style.opacity = "1.0";
    }
}

// --- INITIAL UI SYNC ---
// Runs the refresh logic immediately so the Light Mech, Shield, 
// and Weight Bar are correctly displayed on the first frame.
refreshGarage();

</script>
</body>
</html>
