<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tech Warrior 2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .garage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,20,0,0.95); padding: 20px; border: 2px solid #0f0; pointer-events: auto; width: 450px; }
        .row { margin-bottom: 10px; border-bottom: 1px solid #040; padding-bottom: 5px; display: flex; align-items: center; }
        .label { width: 100px; font-size: 11px; }
        button { background: #020; color: #0f0; border: 1px solid #0f0; cursor: pointer; padding: 5px; margin: 2px; font-size: 11px; }
        button.selected { background: #0f0; color: #000; }
        #weight-meter { text-align: center; font-weight: bold; margin: 10px; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="garage" id="garage-menu">
        <h2 style="text-align:center;">MECH ASSEMBLY</h2>
        <div id="controls-root"></div>
        <div id="weight-meter">...</div>
        <button id="deploy-btn" style="width:100%; height:40px; background:#0f0; color:#000;" onclick="deploy()">DEPLOY</button>
    </div>
</div>

<script>
// 1. DATA
const WEAPONS = {
    mg:     { name: 'MG', w: 15, c: 0xaaaaaa, reload: 200 },
    heavy:  { name: 'Heavy', w: 45, c: 0x555555, reload: 2000 },
    shield: { name: 'Shield', w: 30, c: 0x00ffff, isShield: true },
    sword:  { name: 'Sword', w: 20, c: 0xffffff, isMelee: true }
};
const CHASSIS = {
    light:  { max: 75,  spd: 400, scale: 0.7 },
    medium: { max: 125, spd: 300, scale: 1.0 },
    heavy:  { max: 210, spd: 200, scale: 1.4 }
};
let loadout = { chassis: 'medium', L: 'mg', R: 'heavy', color: 0x00ff00 };
let activeArm = 'L';
let reloadL = 0, reloadR = 0;

// 2. GAME SCENE
class MainScene extends Phaser.Scene {
    constructor() { super('MainScene'); }

    create() {
        this.add.grid(window.innerWidth/2, window.innerHeight/2, 4000, 4000, 64, 64, 0x000000, 0, 0x003300, 0.5);
        this.keys = this.input.keyboard.addKeys('W,A,S,D,SPACE');
        this.bullets = this.physics.add.group();
        this.enemies = this.physics.add.group();
        
        // Setup HUD
        this.hud = this.add.container(0, 0).setDepth(100).setVisible(false).setScrollFactor(0);
        this.hpBar = this.add.rectangle(120, window.innerHeight - 40, 200, 20, 0x00ff00);
        this.hud.add(this.hpBar);

        this.input.on('pointerdown', () => this.fire());
        this.input.on('wheel', () => activeArm = (activeArm === 'L' ? 'R' : 'L'));

        for(let i=0; i<6; i++) {
            let e = this.add.rectangle(Phaser.Math.Between(100, 700), Phaser.Math.Between(100, 500), 40, 40, 0xff0000);
            this.enemies.add(e);
            this.physics.add.existing(e);
            e.body.setVelocity(Phaser.Math.Between(-100, 100), Phaser.Math.Between(-100, 100)).setBounce(1,1).setCollideWorldBounds(true);
        }
    }

    spawn() {
        const sc = CHASSIS[loadout.chassis].scale;
        
        // LEGS (The physical body)
        this.legs = this.add.rectangle(window.innerWidth/2, window.innerHeight/2, 50, 50, 0x333333);
        this.physics.add.existing(this.legs);
        this.legs.setScale(sc).setDepth(10);
        this.legs.body.setCollideWorldBounds(true);

        // TORSO (Follows legs)
        this.torso = this.add.rectangle(0, 0, 60, 60, loadout.color).setStrokeStyle(2, 0xffffff);
        this.torso.setScale(sc).setDepth(20);

        // ARMS (Visual only)
        this.lArmVis = this.add.rectangle(-35 * sc, 0, 20 * sc, 40 * sc, WEAPONS[loadout.L].c);
        this.rArmVis = this.add.rectangle(35 * sc, 0, 20 * sc, 40 * sc, WEAPONS[loadout.R].c);
        
        this.hud.setVisible(true);
        this.isDeployed = true;
    }

    update(time) {
        if (!this.isDeployed) return;

        // Torso follows legs exactly
        this.torso.x = this.legs.x;
        this.torso.y = this.legs.y;
        this.lArmVis.x = this.legs.x + Math.cos(this.torso.rotation - Math.PI/2) * (35 * CHASSIS[loadout.chassis].scale);
        this.lArmVis.y = this.legs.y + Math.sin(this.torso.rotation - Math.PI/2) * (35 * CHASSIS[loadout.chassis].scale);
        this.rArmVis.x = this.legs.x + Math.cos(this.torso.rotation + Math.PI/2) * (35 * CHASSIS[loadout.chassis].scale);
        this.rArmVis.y = this.legs.y + Math.sin(this.torso.rotation + Math.PI/2) * (35 * CHASSIS[loadout.chassis].scale);

        // Rotate Torso to Mouse
        this.torso.rotation = Phaser.Math.Angle.Between(this.torso.x, this.torso.y, this.input.x, this.input.y);
        this.lArmVis.rotation = this.torso.rotation;
        this.rArmVis.rotation = this.torso.rotation;

        // Move Legs
        let speed = CHASSIS[loadout.chassis].spd;
        this.legs.body.setVelocity(0);
        if (this.keys.W.isDown) this.physics.velocityFromRotation(this.legs.rotation, speed, this.legs.body.velocity);
        if (this.keys.S.isDown) this.physics.velocityFromRotation(this.legs.rotation, -speed/2, this.legs.body.velocity);
        if (this.keys.A.isDown) this.legs.setAngularVelocity(-200);
        else if (this.keys.D.isDown) this.legs.setAngularVelocity(200);
        else this.legs.setAngularVelocity(0);
    }

    fire() {
        if (!this.isDeployed) return;
        let now = this.time.now;
        let wKey = activeArm === 'L' ? loadout.L : loadout.R;
        let reloadTime = activeArm === 'L' ? reloadL : reloadR;

        if (now < reloadTime) return;

        let b = this.add.circle(this.torso.x, this.torso.y, wKey === 'heavy' ? 12 : 6, 0xffff00);
        this.physics.add.existing(b);
        this.physics.velocityFromRotation(this.torso.rotation, 600, b.body.velocity);
        
        if (activeArm === 'L') reloadL = now + WEAPONS[wKey].reload;
        else reloadR = now + WEAPONS[wKey].reload;
    }
}

// 3. UI
function buildUI() {
    const root = document.getElementById('controls-root');
    root.innerHTML = '';
    const cats = [{l:'CHASSIS', k:'chassis', d:CHASSIS}, {l:'LEFT', k:'L', d:WEAPONS}, {l:'RIGHT', k:'R', d:WEAPONS}];
    cats.forEach(c => {
        let row = document.createElement('div'); row.className = 'row';
        row.innerHTML = `<div class="label">${c.l}</div>`;
        Object.keys(c.d).forEach(key => {
            let b = document.createElement('button');
            b.innerText = key.toUpperCase();
            if(loadout[c.k] === key) b.className = 'selected';
            b.onclick = () => { loadout[c.k] = key; buildUI(); };
            row.appendChild(b);
        });
        root.appendChild(row);
    });
}

function deploy() {
    const scene = game.scene.getScene('MainScene');
    document.getElementById('garage-menu').style.display = 'none';
    scene.spawn();
}

const config = { type: Phaser.AUTO, width: window.innerWidth, height: window.innerHeight, physics: { default: 'arcade' }, scene: MainScene };
const game = new Phaser.Game(config);
window.onload = buildUI;
</script>
</body>
</html>
