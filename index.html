<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tech Warrior: Alpha 3.0</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: 'Courier New', monospace; overflow: hidden; }
        #ui-layer { position: absolute; top: 0; left: 0; z-index: 10; width: 100%; height: 100%; pointer-events: none; }
        
        /* Garage Menu */
        .stat-readout { background: rgba(0,25,0,0.9); padding: 20px; border: 1px solid #0f0; width: 450px; pointer-events: auto; box-shadow: 0 0 15px #0f0; margin: 20px; }
        .row { margin-bottom: 8px; }
        button { background: #050; color: #0f0; border: 1px solid #0f0; cursor: pointer; margin: 2px; padding: 6px; font-weight: bold; pointer-events: auto; }
        button:hover { background: #0f0; color: #000; }
        button.active { background: #0f0; color: #000; }

        /* Unified HUD Console */
        #hud-container { position: absolute; bottom: 30px; left: 30px; z-index: 100; visibility: hidden; }
        .console-frame { 
            display: flex; 
            align-items: flex-end; 
            gap: 20px; 
            padding: 15px; 
            background: rgba(0, 20, 0, 0.8); 
            border: 2px solid #0f0; 
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.3); 
        }

        .stats-group { display: flex; flex-direction: column; gap: 4px; }
        .hud-label { font-weight: bold; font-size: 14px; text-shadow: 0 0 5px #0f0; }
        
        #hp-bar { width: 250px; height: 22px; border: 2px solid #0f0; background: rgba(0, 40, 0, 0.5); }
        #hp-fill { height: 100%; background: #0f0; transition: width 0.2s; }
        
        #sh-bar { width: 250px; height: 8px; border: 1px solid #00ffff; background: rgba(0, 20, 40, 0.5); }
        #sh-fill { height: 100%; background: #00ffff; box-shadow: 0 0 8px #00ffff; transition: width 0.3s; }

        #weapon-slots { display: flex; gap: 10px; }
        .weapon-box { 
            width: 65px; height: 65px; border: 2px solid #0f0; background: rgba(0, 40, 0, 0.6); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: #0f0; 
        }
        .weapon-box.active-firing { border-color: #fff; box-shadow: 0 0 10px #fff; color: #fff; transform: scale(1.1); }
        
        .arm-label { opacity: 0.7; font-size: 10px; }
        .weap-name { font-weight: bold; font-size: 12px; }

        .color-btn { width: 34px; height: 34px; border: 2px solid #050; display: inline-block; cursor: pointer; margin-right: 8px; border-radius: 4px; pointer-events: auto; }
        .color-btn.active { border: 3px solid #fff; box-shadow: 0 0 10px #fff; }
        .pulse-warning { animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { opacity: 1; } to { opacity: 0.4; } }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="stat-readout" id="garage-menu">
        <h2 style="text-align:center; margin-top:0;">--- MECH HANGAR ---</h2>
        <div class="row">CHASSIS: 
            <button id="c-light" onclick="setChassis('light')">Light</button>
            <button id="c-medium" onclick="setChassis('medium')" class="active">Medium</button>
            <button id="c-heavy" onclick="setChassis('heavy')">Heavy</button>
        </div>
        <div class="row">LEFT ARM: 
            <button id="l-mg" onclick="setWeapon('L','mg')" class="active">MG</button>
            <button id="l-heavy" onclick="setWeapon('L','heavy')">HVY</button>
            <button id="l-sword" onclick="setWeapon('L','sword')">SWRD</button>
        </div>
        <div class="row">RIGHT ARM: 
            <button id="r-shield" onclick="setWeapon('R','shield')">SHLD</button>
            <button id="r-gl" onclick="setWeapon('R','gl')" class="active">GL</button>
        </div>
        <div class="row">SYSTEM MOD: 
            <button id="m-none" onclick="setMod('none')" class="active">NONE</button>
            <button id="m-jump" onclick="setMod('jump')">JUMP JETS</button>
        </div>
        <div class="row">COLOR: 
            <div id="col-00ff00" class="color-btn active" style="background:#00ff00" onclick="setColor(0x00ff00)"></div>
            <div id="col-0088ff" class="color-btn" style="background:#0088ff" onclick="setColor(0x0088ff)"></div>
            <div id="col-ff3300" class="color-btn" style="background:#ff3300" onclick="setColor(0xff3300)"></div>
            <div id="col-ffff00" class="color-btn" style="background:#ffff00" onclick="setColor(0xffff00)"></div>
        </div>
        <hr style="border:0; border-top:1px solid #0f0; margin:10px 0;">
        <div id="weight-display" style="text-align:center; font-weight:bold;">TONNAGE: 125 / 150</div>
        <button id="deploy-btn" style="width:100%; font-size: 18px; margin-top:10px;" onclick="deployMech()">DEPLOY UNIT</button>
    </div>

    <div id="hud-container">
        <div class="console-frame">
            <div class="stats-group">
                <div class="hud-label">HEALTH</div>
                <div id="hp-bar"><div id="hp-fill" style="width: 100%;"></div></div>
                <div class="hud-label" style="color: #00ffff;">SHIELD</div>
                <div id="sh-bar"><div id="sh-fill" style="width: 100%;"></div></div>
            </div>
            <div id="weapon-slots">
                <div id="slot-L" class="weapon-box"><span class="arm-label">L-ARM</span><span id="txt-L" class="weap-name">MG</span></div>
                <div id="slot-R" class="weapon-box"><span class="arm-label">R-ARM</span><span id="txt-R" class="weap-name">GL</span></div>
            </div>
        </div>
    </div>
</div>

<script>
const WEAPONS = {
    none:  { name: 'NONE', color: 0x333333, reload: 0, dmg: 0, w: 0 },
    mg:    { name: 'MG', color: 0xaaaaaa, reload: 200, dmg: 10, w: 50 },
    heavy: { name: 'HEAVY', color: 0x555555, reload: 1500, dmg: 40, w: 75 },
    sword: { name: 'SWORD', color: 0xffffff, reload: 600, dmg: 60, isMelee: true, w: 50 },
    shield:{ name: 'SHIELD', color: 0x00ffff, isShield: true, w: 25 },
    gl:    { name: 'G.LAUNCHER', color: 0xffaa00, reload: 3500, dmg: 100, isGL: true, w: 100 }
};

const CHASSIS = {
    light:  { max: 100, spd: 400, scale: 0.7, hp: 300 },
    medium: { max: 150, spd: 280, scale: 1.0, hp: 450 },
    heavy:  { max: 200, spd: 180, scale: 1.4, hp: 600 }
};

let loadout = { chassis: 'medium', L: 'mg', R: 'gl', mod: 'none', color: 0x00ff00 };
let player, torso, cockpit, legMarker, swordSlash, keys, bullets, enemies, shieldGraphic;
let reloadBar, reloadBg, jumpBar, jumpBg, isDeployed = false, activeArm = 'L', reloadL = 0, reloadR = 0, lastJumpTime = 0, lastDamageTime = 0, isJumping = false, smokeParticles;

const config = {
    type: Phaser.AUTO,
    width: window.innerWidth, height: window.innerHeight,
    physics: { default: 'arcade' },
    scene: { preload: preload, create: create, update: update }
};
const game = new Phaser.Game(config);

function preload() {
    let g = this.make.graphics({x: 0, y: 0, add: false});
    g.fillStyle(0xffffff, 1); g.fillCircle(10, 10, 10);
    g.generateTexture('smoke', 20, 20);
}

function create() {
    this.add.grid(window.innerWidth/2, window.innerHeight/2, 4000, 4000, 64, 64, 0, 0, 0x004400, 0.3);
    keys = this.input.keyboard.addKeys('W,A,S,D,SPACE');
    
    // 1. Initialize the group
    bullets = this.physics.add.group();
    enemies = this.physics.add.group();

    // 2. Setup the Overlap (The "Collision Rules")
    // This MUST exist and point to the 'bullets' group
    this.physics.add.overlap(bullets, enemies, (bullet, enemy) => {
        // Only destroy regular bullets (GL balls have their own explosion logic)
        if (!bullet.isGLBall) {
            bullet.destroy(); 
            damageEnemy(enemy, 15); // MG Damage
        }
    });

    this.input.on('pointerdown', () => fire(this));
    this.input.on('wheel', () => { activeArm = (activeArm === 'L' ? 'R' : 'L'); updateHUD(); });
    for(let i=0; i<6; i++) spawnEnemy(this);
}

function spawnEnemy(scene) {
    let x = Phaser.Math.Between(200, window.innerWidth - 200);
    let y = Phaser.Math.Between(200, window.innerHeight - 200);
    let e = scene.add.rectangle(x, y, 40, 40, 0xff0000).setStrokeStyle(2, 0xffffff);
    scene.physics.add.existing(e);
    e.health = 50;
    e.bar = scene.add.rectangle(x, y-35, 40, 5, 0x00ff00);
    enemies.add(e);
}

function damageEnemy(e, amt) {
    e.health -= amt;
    if(e.bar) e.bar.width = Math.max(0, (e.health / 50) * 40);
    if (e.health <= 0) { if(e.bar) e.bar.destroy(); e.destroy(); setTimeout(() => spawnEnemy(game.scene.scenes[0]), 2000); }
}

function deployMech() {
    document.getElementById('garage-menu').style.display = 'none';
    document.getElementById('hud-container').style.visibility = 'visible';
    let scene = game.scene.scenes[0];
    let s = CHASSIS[loadout.chassis];

    player = scene.add.rectangle(window.innerWidth/2, window.innerHeight/2, 70, 50, 0x222222).setStrokeStyle(2, 0xffffff).setDepth(5);
    scene.physics.add.existing(player);
    player.setScale(s.scale).body.setCollideWorldBounds(true);
    
    // Initialize Stats
    player.maxHp = s.hp; 
    player.hp = s.hp;
    player.shield = 100;

    legMarker = scene.add.rectangle(0, 0, 6, 50, 0xff6600).setDepth(6).setScale(s.scale);
    torso = scene.add.rectangle(0, 0, 55, 55, loadout.color).setStrokeStyle(2, 0xffffff).setDepth(10).setScale(s.scale);
    cockpit = scene.add.rectangle(0, 0, 20, 10, 0xff6600).setDepth(12);
    
    swordSlash = scene.add.arc(0, 0, 60, 0, 90, false, 0xffffff, 0.8).setVisible(false).setDepth(15);
    reloadBg = scene.add.rectangle(0, 0, 50, 6, 0x333333).setDepth(20).setVisible(false);
    reloadBar = scene.add.rectangle(0, 0, 50, 6, 0xffff00).setDepth(21).setVisible(false);
    jumpBg = scene.add.rectangle(0, 0, 50, 4, 0x331100).setDepth(15).setVisible(false);
    jumpBar = scene.add.rectangle(0, 0, 50, 4, 0xff6600).setDepth(16).setVisible(false);
    shieldGraphic = scene.add.arc(0,0, 70, 330, 30, false, 0x00ffff, 0.3).setStrokeStyle(3, 0x00ffff).setVisible(false).setDepth(12);
    smokeParticles = scene.add.particles(0, 0, 'smoke', { scale: { start: 0.5, end: 0 }, alpha: { start: 0.4, end: 0 }, lifespan: 500, speed: 30, follow: player, on: false }).setDepth(4);

    isDeployed = true;
    updateHUD();
}

function fire(scene) {
    if (!isDeployed || isJumping) return;
    let now = scene.time.now;
    let wKey = activeArm === 'L' ? loadout.L : loadout.R;
    let weapon = WEAPONS[wKey];
    let last = activeArm === 'L' ? reloadL : reloadR;

    if (now < last || weapon.isShield || wKey === 'none') return;

    // Visual feedback for the UI slot
    let slotId = 'slot-' + activeArm;
    document.getElementById(slotId).classList.add('active-firing');
    scene.time.delayedCall(100, () => document.getElementById(slotId).classList.remove('active-firing'));

    if (weapon.isGL) {
        let targetX = scene.input.activePointer.worldX;
        let targetY = scene.input.activePointer.worldY;
        let distance = Phaser.Math.Distance.Between(torso.x, torso.y, targetX, targetY);
        
        let ball = scene.add.circle(torso.x, torso.y, 10, 0xffaa00).setStrokeStyle(2, 0xffffff).setDepth(14);
        scene.physics.add.existing(ball);
        ball.isGLBall = true;
        scene.physics.velocityFromRotation(torso.rotation, distance * 2, ball.body.velocity);
        ball.body.setDrag(distance * 2); 

        // FIX: Improved Timer Text Logic
        let timerText = scene.add.text(ball.x, ball.y - 25, '3', { fontSize: '18px', color: '#fff', fontStyle: 'bold' }).setOrigin(0.5).setDepth(20);
        let count = 3;

        // Update text position every frame
        const updateTimerPos = () => {
            if (ball.active && timerText.active) {
                timerText.setPosition(ball.x, ball.y - 25);
            } else {
                scene.events.off('update', updateTimerPos);
            }
        };
        scene.events.on('update', updateTimerPos);

        scene.time.addEvent({
            delay: 1000, repeat: 2,
            callback: () => {
                count--;
                if (count > 0) { 
                    if (timerText.active) timerText.setText(count); 
                } else if (ball.active) {
                    let blast = scene.add.circle(ball.x, ball.y, 100, 0xff6600, 0.6).setDepth(15);
                    scene.physics.add.existing(blast);
                    scene.physics.add.overlap(blast, enemies, (z, e) => damageEnemy(e, 100));
                    
                    if (Phaser.Math.Distance.Between(blast.x, blast.y, player.x, player.y) < 100) {
                        takePlayerDamage(75);
                    }
                    
                    scene.tweens.add({ targets: blast, scale: 1.5, alpha: 0, duration: 300, onComplete: () => blast.destroy() });
                    timerText.destroy(); 
                    ball.destroy();
                }
            }
        });
    } else if (weapon.isMelee) {
        swordSlash.setPosition(player.x, player.y).setRotation(torso.rotation - 0.7).setVisible(true);
        scene.time.delayedCall(150, () => swordSlash.setVisible(false));
        let hit = scene.add.circle(torso.x + Math.cos(torso.rotation)*50, torso.y + Math.sin(torso.rotation)*50, 50);
        scene.physics.add.existing(hit);
        scene.physics.add.overlap(hit, enemies, (z, e) => damageEnemy(e, weapon.dmg));
        scene.time.delayedCall(100, () => hit.destroy());
} else {
        // --- STEP 1: CREATE THE BULLET ---
        let bulletSize = (wKey === 'heavy') ? 12 : 6;
        let b = scene.add.circle(torso.x, torso.y, bulletSize, 0xffff00);
        
        scene.physics.add.existing(b); 
        bullets.add(b); 
        scene.physics.velocityFromRotation(torso.rotation, 1000, b.body.velocity);
        
        // --- STEP 2: APPLY KICKBACK (ONLY FOR HEAVY GUN) ---
        if (wKey === 'heavy') {
            const kickbackForce = 150; 
            // We subtract the force from the player's current velocity
            // to push them in the opposite direction of the shot.
            player.body.velocity.x -= Math.cos(torso.rotation) * kickbackForce;
            player.body.velocity.y -= Math.sin(torso.rotation) * kickbackForce;
            
            // Add a small camera shake for impact
            scene.cameras.main.shake(100, 0.005);
        }

        // --- STEP 3: CLEANUP ---
        scene.time.delayedCall(2000, () => { if(b.active) b.destroy(); });
    }

    if (activeArm === 'L') { reloadL = now + weapon.reload; player.lastL = now; }
    else { reloadR = now + weapon.reload; player.lastR = now; }
}

function takePlayerDamage(amt) {
    lastDamageTime = game.scene.scenes[0].time.now;
    let wKey = activeArm === 'L' ? loadout.L : loadout.R;
    let isShieldActive = WEAPONS[wKey].isShield && !isJumping;

    if (isShieldActive && player.shield > 0) {
        player.shield -= amt * 0.5;
        amt *= 0.5;
        if (player.shield < 0) player.shield = 0;
    }

    player.hp -= amt;
    updateBars();

    torso.setFillStyle(0xffffff);
    game.scene.scenes[0].time.delayedCall(50, () => torso.setFillStyle(loadout.color));
    if (player.hp <= 0) location.reload();
}

function updateBars() {
    let hpPercent = (player.hp / player.maxHp) * 100;
    document.getElementById('hp-fill').style.width = Math.max(0, hpPercent) + "%";
    document.getElementById('sh-fill').style.width = Math.max(0, player.shield) + "%";
    document.getElementById('hp-fill').style.background = hpPercent < 25 ? "red" : "#0f0";
}

function update(time) {
    if (!isDeployed) return;

    // Shield Regen Logic
    if (time > lastDamageTime + 3000 && player.shield < 100) {
        player.shield += 0.2;
        updateBars();
    }

    let s = CHASSIS[loadout.chassis].spd;
    if (keys.SPACE.isDown && loadout.mod === 'jump' && !isJumping && time > lastJumpTime + 2000) {
        isJumping = true; lastJumpTime = time;
        this.physics.velocityFromRotation(player.rotation, 600, player.body.velocity);
        this.tweens.add({ targets: [player, torso, cockpit, legMarker], scale: '+=0.2', duration: 200, yoyo: true, onComplete: () => isJumping = false });
    }
    if (!isJumping) {
        player.body.setVelocity(0);
        if (keys.W.isDown) this.physics.velocityFromRotation(player.rotation, s, player.body.velocity);
        if (keys.S.isDown) this.physics.velocityFromRotation(player.rotation, -s/2, player.body.velocity);
        if (keys.A.isDown) player.body.setAngularVelocity(-200);
        else if (keys.D.isDown) player.body.setAngularVelocity(200);
        else player.body.setAngularVelocity(0);
    }
    torso.setPosition(player.x, player.y);
    let angle = Phaser.Math.Angle.Between(player.x, player.y, this.input.activePointer.worldX, this.input.activePointer.worldY);
    torso.setRotation(angle);
    legMarker.setPosition(player.x + Math.cos(player.rotation)*(35*player.scale), player.y + Math.sin(player.rotation)*(35*player.scale)).setRotation(player.rotation);
    cockpit.setPosition(player.x + Math.cos(angle)*(25*player.scale), player.y + Math.sin(angle)*(25*player.scale)).setRotation(angle);
    
    let weapon = WEAPONS[activeArm === 'L' ? loadout.L : loadout.R];
    shieldGraphic.setPosition(player.x, player.y).setRotation(angle).setVisible(weapon.isShield && !isJumping);
}

function updateHUD() {
    document.getElementById('txt-L').innerText = loadout.L.toUpperCase();
    document.getElementById('txt-R').innerText = loadout.R.toUpperCase();
    document.getElementById('slot-L').style.borderColor = activeArm === 'L' ? '#fff' : '#0f0';
    document.getElementById('slot-R').style.borderColor = activeArm === 'R' ? '#fff' : '#0f0';
    document.getElementById('slot-L').style.opacity = activeArm === 'L' ? '1' : '0.5';
    document.getElementById('slot-R').style.opacity = activeArm === 'R' ? '1' : '0.5';
}

function setChassis(t) { loadout.chassis = t; refreshGarage(); }
function setWeapon(s, t) { if(s === 'L') loadout.L = t; else loadout.R = t; refreshGarage(); }
function setMod(t) { loadout.mod = t; refreshGarage(); }
function setColor(c) { loadout.color = c; refreshGarage(); }

function refreshGarage() {
    document.querySelectorAll('button, .color-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('c-'+loadout.chassis).classList.add('active');
    document.getElementById('l-'+loadout.L).classList.add('active');
    document.getElementById('r-'+loadout.R).classList.add('active');
    document.getElementById('m-'+loadout.mod).classList.add('active');
    let cid = "col-" + loadout.color.toString(16).padStart(6, '0');
    if(document.getElementById(cid)) document.getElementById(cid).classList.add('active');
    let total = WEAPONS[loadout.L].w + WEAPONS[loadout.R].w + (loadout.mod === 'jump' ? 25 : 0);
    let max = CHASSIS[loadout.chassis].max;
    document.getElementById('weight-display').innerText = `TONNAGE: ${total} / ${max}`;
    document.getElementById('weight-display').style.color = total > max ? '#f00' : '#0f0';
    document.getElementById('deploy-btn').disabled = total > max;
}
</script>
</body>
</html>
